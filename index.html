<!doctype html>
<html lang="en">
  <head>
    <script src="https://hv-camera-web-sg.s3-ap-southeast-1.amazonaws.com/hyperverge-web-sdk@9.15.2/src/sdk.min.js"></script>
  </head>

  <body>
    <div style="position: fixed; top: 10%; left: 37%">
      <div style="text-align: center">
        <input
          type="text"
          id="email"
          placeholder="Enter User Name"
          style="margin-bottom: 1rem"
        />
        <br />

        <button type="button" onclick="starOnboarding();">
          Start Onboarding
        </button>
      </div>
      <textarea
        type="text"
        id="myTextBox"
        rows="50"
        cols="50"
        style="resize: both; margin-top: 1rem"
      >
      </textarea>
    </div>
  </body>
  <script>
    const textBox = document.getElementById("myTextBox");

    const http = "https://8d73abd02a85.ngrok-free.app";

    function generateCustomerId() {
      const characters =
        "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
      let customerId = "";
      for (let i = 0; i < 26; i++) {
        const randomIndex = Math.floor(Math.random() * characters.length);
        customerId += characters[randomIndex];
      }
      return customerId;
    }

    // Hàm tạo transactionId với tiền tố TX_ và 23 ký tự ngẫu nhiên
    function generateTransactionId() {
      const characters =
        "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
      let transactionId = "TX_";
      for (let i = 0; i < 23; i++) {
        const randomIndex = Math.floor(Math.random() * characters.length);
        transactionId += characters[randomIndex];
      }
      return transactionId;
    }

    const getAuthToken = async () => {
      const email = document.getElementById("email").value;
      if (!email) {
        alert("Please enter email");
        throw new Error("Email is required");
      }

      const transactionId = generateTransactionId();
      const customerId = generateCustomerId();

      const response = await fetch(http + "/kyc/generate-kyc-token", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          transactionId,
          email,
        }),
      });
      const data = await response.json();
      return data.result.authToken;
    };

    const saveKycResult = async ({transaction_id, customer_id}) => {
      const result = {
        transaction_id,
        customer_id,
      };

      const response = await fetch(http + "/kyc/save-kyc-verification", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(result),
      });
      const data = await response.json();
      return data;
    };

    async function starOnboarding() {
      const authToken = await getAuthToken();
      const accessToken = authToken;

      const hyperKycConfig = new HyperKycConfig(accessToken, true);

      const languageToBeUsed = "vi";
      hyperKycConfig.setLanguageUsed(languageToBeUsed);

      HyperKYCModule.launch(hyperKycConfig, handler);
    }
    const handler = async (HyperKycResult) => {
      textBox.value = JSON.stringify(HyperKycResult, null, 2);
        console.log(HyperKycResult);
        const customer_id = generateCustomerId();
      await saveKycResult({
        transaction_id: HyperKycResult.transactionId,
        customer_id: customer_id,
      });
      switch (HyperKycResult.status) {
        // ----Incomplete workflow-----
        case "user_cancelled":
          // <<Insert code block 1>>
          console.log("user_cancelled");
          break;
        case "error":
          // <<Insert code block 2>>
          console.log("error");
          break;

        // ----Complete workflow-----

        case "auto_approved":
          // <<Insert code block 3>>
          console.log("auto_approved");
          break;
        case "auto_declined":
          // <<Insert code block 4>>
          console.log("auto_declined");
          break;
        case "needs_review":
          // <<Insert code block 5>>
          console.log("needs_review");
          break;
      }
    };
  </script>
</html>
