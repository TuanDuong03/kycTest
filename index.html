<!doctype html>
<html lang="en">
  <head>
    <script src="https://hv-camera-web-sg.s3-ap-southeast-1.amazonaws.com/hyperverge-web-sdk@9.15.2/src/sdk.min.js"></script>
  </head>

  <body>
    <div style="position: fixed; top: 10%; left: 37%">
      <div style="text-align: center">
        <button type="button" onclick="starOnboarding();">Start KYC</button>
      </div>
      <textarea
        type="text"
        id="myTextBox"
        rows="50"
        cols="50"
        style="resize: both; margin-top: 1rem"
      >
      </textarea>
    </div>
  </body>
  <script>
    const textBox = document.getElementById("myTextBox");

    const http = "https://8d73abd02a85.ngrok-free.app";

    function generateTransactionId() {
      const characters =
        "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
      let transactionId = "";
      for (let i = 0; i < 26; i++) {
        const randomIndex = Math.floor(Math.random() * characters.length);
        transactionId += characters[randomIndex];
      }
      return transactionId;
    }

    const getAuthToken = async ({ transaction_id }) => {
      const response = await fetch(http + "/kyc/generate-kyc-token", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          transaction_id: transactionId,
        }),
      });
      const data = await response.json();
      return data.result.authToken;
    };

    const startKyc = async ({ transaction_id }) => {
      await fetch(http + "/kyc/start-kyc", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          transaction_id,
        }),
      });
    };

    const saveKycResult = async ({ transaction_id }) => {
      const result = {
        transaction_id,
      };

      const response = await fetch(http + "/kyc/save-kyc-verification", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(result),
      });
      const data = await response.json();
      return data;
    };

    async function starOnboarding() {
      const transactionId = generateTransactionId();
      const authToken = await getAuthToken({ transaction_id: transactionId });
      const accessToken = authToken;

      const hyperKycConfig = new HyperKycConfig(accessToken, true);

      const languageToBeUsed = "vi";
      hyperKycConfig.setLanguageUsed(languageToBeUsed);

      startKyc({ transaction_id: transactionId });
      HyperKYCModule.launch(hyperKycConfig, handler);
    }
    const handler = async (HyperKycResult) => {
      textBox.value = JSON.stringify(HyperKycResult, null, 2);
      console.log(HyperKycResult);
      await saveKycResult({
        transaction_id: HyperKycResult.transactionId,
      });
      switch (HyperKycResult.status) {
        // ----Incomplete workflow-----
        case "user_cancelled":
          // <<Insert code block 1>>
          console.log("user_cancelled");
          break;
        case "error":
          // <<Insert code block 2>>
          console.log("error");
          break;

        // ----Complete workflow-----

        case "auto_approved":
          // <<Insert code block 3>>
          console.log("auto_approved");
          break;
        case "auto_declined":
          // <<Insert code block 4>>
          console.log("auto_declined");
          break;
        case "needs_review":
          // <<Insert code block 5>>
          console.log("needs_review");
          break;
      }
    };
  </script>
</html>
